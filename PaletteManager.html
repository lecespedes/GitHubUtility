<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Color Palette Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      text-shadow: 1px 1px 1px #eee;
    }

    header {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      align-items: center;
      background-color: darkgray;
      margin-bottom: 10px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      padding: 1rem;
      justify-content: center;
    }

    .palette-container {
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 8px;
      display: flex;
    }

    .axis-swatches {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .axis-swatch-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }

    .axis-swatch-group label {
      font-size: 0.9rem;
      font-weight: bold;
      width: 20px;
    }

    .swatch-line {
      display: flex;
      flex-wrap: nowrap;
      position: relative;
    }

    .swatch {
      height: 1rem;
      cursor: pointer;
      border-right: 1px solid #f5f5f5;
      position: relative;
    }

    .caret {
      position: absolute;
      top: 1rem;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 5px solid #333;
      transform: translateX(-50%);
      display: none;
    }

    .input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      text-align: center;
    }

    .input-group label {
      font-size: 0.9rem;
      font-weight: bold;
    }

    .input-group input {
      width: 100px;
      padding: 0.5rem;
      border: 1px solid #aaa;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    #colorSwatch {
      width: 75px;
      height: 50px;
      border: 1px outset #fff;
      border-radius: 8px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .palette-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .palette-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .palette-input-group label {
      font-size: 0.9rem;
    }

    .palette-input-group input {
      width: 60px;
      padding: 0.25rem .5rem;
      border: 1px solid #aaa;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .saturation-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .saturation-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .saturation-input-group label {
      font-size: 0.9rem;
      font-weight: bold;
    }

    .saturation-input-group input {
      width: 55px;
      padding: 2px 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .visibility-controls {
      position: relative;
      display: inline-block;
    }

    .visibility-button {
      padding: 0.25rem 1rem;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #eee;
      cursor: pointer;
      font-size: 1rem;
    }

    .visibility-dropdown {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      z-index: 1000;
      min-width: 200px;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
      border-bottom: none;
    }

    .visibility-dropdown.active {
      display: block;
    }

    .visibility-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      justify-content: space-between;
      border-bottom: 1px solid #aaa;
    }

    .visibility-option:hover {
      background-color: #ddd;
    }

    .visibility-option input {
      cursor: pointer;
    }

    .visibility-option label {
      font-size: 0.9rem;
      cursor: pointer;
    }

    .switch-label {
      font-size: 0.9rem;
      color: #333;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
      border: 1px inset #ccc;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 25px;
      width: 25px;
      left: 2px;
      top: 1px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
      border: 1px outset #ccc;
    }

    input:checked + .slider {
      background-color: #666;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .palette-swatches {
      display: grid;
    }

    .primary-container {
      background: #ddd;
      border-radius: 8px;
    }

    .palette-swatch-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 10px;
      position: relative;
    }

    .palette-swatch-group label {
      font-size: 0.9rem;
      font-weight: bold;
      width: 120px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .palette-swatch-group .swatch-info label {
      width: auto;
    }

    .palette-swatch-line {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
    }

    .palette-swatch-column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .palette-swatch-column .palette-swatch-group {
      flex-direction: column;
      align-items: center;
    }

    .palette-swatch-column .palette-swatch-group label {
      width: auto;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .swatch-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
    }

    .swatch-lightness {
      font-size: 0.7rem;
      color: #333;
      text-align: center;
      order: -1; /* Place above swatch */
    }

    .palette-swatch {
      min-width: 60px;
      height: 50px;
      border: 1px solid #f5f5f5;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
    }

    .palette-swatch.primary {
      border: 2px solid #000;
    }

    .palette-swatch .hex-code {
      font-size: 0.7rem;
      text-align: center;
      pointer-events: none;
    }

    .swatch-info {
      font-size: 0.8rem;
      color: #333;
      font-weight: bold;
      margin-left: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .swatch-info span {
      display: block;
    }

    .swatch-info input {
      width: 50px;
      padding: 0.2rem;
      border: 1px solid #aaa;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
    }

    .palette-swatch-column .swatch-info {
      margin-top: 0.5rem;
      text-align: center;
    }

    .palette-swatch-tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 0.8rem;
      pointer-events: none;
      display: none;
      z-index: 1000;
      white-space: nowrap;
      top: -70px;
      left: 50%;
      transform: translateX(-50%);
    }

    .palette-swatch:hover .palette-swatch-tooltip {
      display: block;
    }

    .palette-header {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }

    .rainbow-button {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px; /* Fixed width to avoid stretching */
      height: 30px;
      background: #eee;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .rainbow-button:hover {
      background: #ddd;
    }

    .saturation-dropdown {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #aaa;
      border-radius: 4px;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      z-index: 10;
    }

    .saturation-dropdown.active {
      display: flex;
    }

    .saturation-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
    }

    .saturation-row:hover {
      background-color: #eee;
    }

    .saturation-row label {
      font-size: 0.9rem;
      width: 50px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Color Palette Manager</h1>
    <div id="colorSwatch"><span class="hex-text"></span></div>
  </header>
  <div class="palette-container" id="palette-container">
    <div class="container">
      <div>
        <div id="rgb-swatches" class="axis-swatches"></div>
        <div class="input-container">
          <div id="rgb-inputs" class="input-container"></div>
        </div>
      </div>
      <div>
        <div id="hsl-swatches" class="axis-swatches"></div>
        <div class="input-container">
          <div id="hsl-inputs" class="input-container"></div>
        </div>
      </div>
    </div>
    <div id="palette-controls-container"></div>
  </div>

  <script type="module">
    //import { ModelManager, UNICODE, colorRelationships, relationshipOrder } from './ModelManager_forPalette.js';
    import { ModelManager, UNICODE, colorRelationships, relationshipOrder } from 'https://cdn.jsdelivr.net/gh/lecespedes/GitHubUtility@main/ModelManager_forPalette.js';

    function getAngleFromValue(_value, _range) {
      const value = parseFloat(_value);
      if (value === 1) return parseFloat(2 * Math.PI); // Handle 100%
      if (value === 0) return 0; // Handle 0%
      const sinValue = parseFloat(2 * value - 1);
      if (Math.abs(sinValue) > 1) return 0;
      const angle = parseFloat((_range / Math.PI) * Math.asin(sinValue) + Math.PI / 2);
      return angle;
    }

    function getValueFromAngle(_theta, _range) {
      const theta = parseFloat(_theta);
      const value = parseFloat((Math.sin((theta / (_range / Math.PI)) - (Math.PI / 2)) + 1) / 2);
      return value;
    }

    function toDegrees(radians) {
      return parseFloat((radians * (180 / Math.PI)) % 360);
    }

    function toRadians(degrees) {
      return parseFloat((degrees % 360) * (Math.PI / 180));
    }

    function normRadians(radians) {
      return parseFloat(((radians % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI));
    }

    class PaletteManager {
      constructor(containerElement) {
        this.containerElement = containerElement;
        this.modelManager = null;
        this.dom = {
          paletteControls: null,
          layoutToggle: null,
          saturationControls: null,
          visibilityControls: null,
          visibilityButton: null,
          visibilityDropdown: null,
          paletteSwatches: null,
          startAngleInput: null,
          endAngleInput: null,
          angleStepInput: null,
          satStartAngleInput: null,
          satEndAngleInput: null,
          satAngleStepInput: null
        };
        this.initializeElements();
      }

      setModelManager(modelManager) {
        this.modelManager = modelManager;
      }

      initializeElements() {
        this.containerElement.style.display = 'flex';
        this.containerElement.style.justifyContent = 'center';
        const paletteColumn = document.createElement('div');
        paletteColumn.style.display = 'flex';
        paletteColumn.style.flexDirection = 'column';
        paletteColumn.style.alignItems = 'center';
        paletteColumn.style.gap = '10px';

        // Create palette-controls
        const paletteControls = document.createElement('div');
        paletteControls.className = 'palette-controls';
        this.dom.paletteControls = paletteControls;

        // Angular Lightness Controls
        const angularLightnessGroup = document.createElement('div');
        angularLightnessGroup.className = 'palette-input-group';
        angularLightnessGroup.style.display = 'flex';
        angularLightnessGroup.style.flexDirection = 'column';
        angularLightnessGroup.style.gap = '5px';

        const angularLightnessTitle = document.createElement('span');
        angularLightnessTitle.textContent = 'Angular Lightness Controls';
        angularLightnessGroup.appendChild(angularLightnessTitle);

        // Lightness Start Angle
        const startAngleGroup = document.createElement('div');
        startAngleGroup.className = 'palette-input-group';
        const startAngleLabel = document.createElement('label');
        startAngleLabel.htmlFor = 'start-angle';
        startAngleLabel.textContent = 'Start Angle';
        const startAngleInput = document.createElement('input');
        startAngleInput.type = 'number';
        startAngleInput.id = 'start-angle';
        startAngleInput.min = '0';
        startAngleInput.max = '360';
        startAngleInput.value = '75';
        const startAngleRange = document.createElement('span');
        startAngleRange.textContent = '(0-360°)';
        startAngleGroup.appendChild(startAngleLabel);
        startAngleGroup.appendChild(startAngleInput);
        startAngleGroup.appendChild(startAngleRange);
        angularLightnessGroup.appendChild(startAngleGroup);
        this.dom.startAngleInput = startAngleInput;

        // Lightness End Angle
        const endAngleGroup = document.createElement('div');
        endAngleGroup.className = 'palette-input-group';
        const endAngleLabel = document.createElement('label');
        endAngleLabel.htmlFor = 'end-angle';
        endAngleLabel.textContent = 'End Angle';
        const endAngleInput = document.createElement('input');
        endAngleInput.type = 'number';
        endAngleInput.id = 'end-angle';
        endAngleInput.min = '0';
        endAngleInput.max = '360';
        endAngleInput.value = '300';
        const endAngleRange = document.createElement('span');
        endAngleRange.textContent = '(0-360°)';
        endAngleGroup.appendChild(endAngleLabel);
        endAngleGroup.appendChild(endAngleInput);
        endAngleGroup.appendChild(endAngleRange);
        angularLightnessGroup.appendChild(endAngleGroup);
        this.dom.endAngleInput = endAngleInput;

        // Lightness Angle Step
        const angleStepGroup = document.createElement('div');
        angleStepGroup.className = 'palette-input-group';
        const angleStepLabel = document.createElement('label');
        angleStepLabel.htmlFor = 'angle-step';
        angleStepLabel.textContent = 'Angle Step';
        const angleStepInput = document.createElement('input');
        angleStepInput.type = 'number';
        angleStepInput.id = 'angle-step';
        angleStepInput.min = '5';
        angleStepInput.max = '90';
        angleStepInput.value = '45';
        const angleStepRange = document.createElement('span');
        angleStepRange.textContent = '(5-90°)';
        angleStepGroup.appendChild(angleStepLabel);
        angleStepGroup.appendChild(angleStepInput);
        angleStepGroup.appendChild(angleStepRange);
        angularLightnessGroup.appendChild(angleStepGroup);
        this.dom.angleStepInput = angleStepInput;

        paletteControls.appendChild(angularLightnessGroup);

        // Angular Saturation Controls
        const angularSaturationGroup = document.createElement('div');
        angularSaturationGroup.className = 'palette-input-group';
        angularSaturationGroup.style.display = 'flex';
        angularSaturationGroup.style.flexDirection = 'column';
        angularSaturationGroup.style.gap = '5px';

        const angularSaturationTitle = document.createElement('span');
        angularSaturationTitle.textContent = 'Angular Saturation Controls';
        angularSaturationGroup.appendChild(angularSaturationTitle);

        // Saturation Start Angle
        const satStartAngleGroup = document.createElement('div');
        satStartAngleGroup.className = 'palette-input-group';
        const satStartAngleLabel = document.createElement('label');
        satStartAngleLabel.htmlFor = 'sat-start-angle';
        satStartAngleLabel.textContent = 'Start Angle';
        const satStartAngleInput = document.createElement('input');
        satStartAngleInput.type = 'number';
        satStartAngleInput.id = 'sat-start-angle';
        satStartAngleInput.min = '0';
        satStartAngleInput.max = '360';
        satStartAngleInput.value = '90';
        const satStartAngleRange = document.createElement('span');
        satStartAngleRange.textContent = '(0-360°)';
        satStartAngleGroup.appendChild(satStartAngleLabel);
        satStartAngleGroup.appendChild(satStartAngleInput);
        satStartAngleGroup.appendChild(satStartAngleRange);
        angularSaturationGroup.appendChild(satStartAngleGroup);
        this.dom.satStartAngleInput = satStartAngleInput;

        // Saturation End Angle
        const satEndAngleGroup = document.createElement('div');
        satEndAngleGroup.className = 'palette-input-group';
        const satEndAngleLabel = document.createElement('label');
        satEndAngleLabel.htmlFor = 'sat-end-angle';
        satEndAngleLabel.textContent = 'End Angle';
        const satEndAngleInput = document.createElement('input');
        satEndAngleInput.type = 'number';
        satEndAngleInput.id = 'sat-end-angle';
        satEndAngleInput.min = '0';
        satEndAngleInput.max = '360';
        satEndAngleInput.value = '270';
        const satEndAngleRange = document.createElement('span');
        satEndAngleRange.textContent = '(0-360°)';
        satEndAngleGroup.appendChild(satEndAngleLabel);
        satEndAngleGroup.appendChild(satEndAngleInput);
        satEndAngleGroup.appendChild(satEndAngleRange);
        angularSaturationGroup.appendChild(satEndAngleGroup);
        this.dom.satEndAngleInput = satEndAngleInput;

        // Saturation Angle Step
        const satAngleStepGroup = document.createElement('div');
        satAngleStepGroup.className = 'palette-input-group';
        const satAngleStepLabel = document.createElement('label');
        satAngleStepLabel.htmlFor = 'sat-angle-step';
        satAngleStepLabel.textContent = 'Angle Step';
        const satAngleStepInput = document.createElement('input');
        satAngleStepInput.type = 'number';
        satAngleStepInput.id = 'sat-angle-step';
        satAngleStepInput.min = '5';
        satAngleStepInput.max = '90';
        satAngleStepInput.value = '30';
        const satAngleStepRange = document.createElement('span');
        satAngleStepRange.textContent = '(5-90°)';
        satAngleStepGroup.appendChild(satAngleStepLabel);
        satAngleStepGroup.appendChild(satAngleStepInput);
        satAngleStepGroup.appendChild(satAngleStepRange);
        angularSaturationGroup.appendChild(satAngleStepGroup);
        this.dom.satAngleStepInput = satAngleStepInput;

        paletteControls.appendChild(angularSaturationGroup);

        // Layout Toggle
        const switchContainer = document.createElement('div');
        switchContainer.className = 'palette-switch-container';
        switchContainer.style.display = 'flex';
        switchContainer.style.alignItems = 'center';
        const rowsLabel = document.createElement('span');
        rowsLabel.className = 'switch-label';
        rowsLabel.textContent = 'Rows ';
        const switchLabel = document.createElement('label');
        switchLabel.className = 'switch';
        switchLabel.style.margin = '0 5px';
        const switchInput = document.createElement('input');
        switchInput.type = 'checkbox';
        switchInput.id = 'layout-toggle';
        const slider = document.createElement('span');
        slider.className = 'slider';
        switchLabel.appendChild(switchInput);
        switchLabel.appendChild(slider);
        const columnsLabel = document.createElement('span');
        columnsLabel.className = 'switch-label';
        columnsLabel.textContent = ' Columns';
        switchContainer.appendChild(rowsLabel);
        switchContainer.appendChild(switchLabel);
        switchContainer.appendChild(columnsLabel);
        paletteControls.appendChild(switchContainer);
        this.dom.layoutToggle = switchInput;

        // Visibility Controls
        const visibilityControls = document.createElement('div');
        visibilityControls.className = 'visibility-controls';
        const visibilityButton = document.createElement('button');
        visibilityButton.className = 'visibility-button';
        visibilityButton.textContent = UNICODE.eye;
        const visibilityDropdown = document.createElement('div');
        visibilityDropdown.className = 'visibility-dropdown';
        visibilityControls.appendChild(visibilityButton);
        visibilityControls.appendChild(visibilityDropdown);
        paletteControls.appendChild(visibilityControls);
        this.dom.visibilityControls = visibilityControls;
        this.dom.visibilityButton = visibilityButton;
        this.dom.visibilityDropdown = visibilityDropdown;

        // Saturation Controls
        const groupSatCtrls = document.createElement('div');
        groupSatCtrls.style.display = 'flex';
        groupSatCtrls.style.flexDirection = 'column';
        groupSatCtrls.style.gap = '10px';
        const groupSatCtrls_Title = document.createElement('span');
        groupSatCtrls_Title.textContent = 'Color Relationship Group Saturation (0-100%)';
        groupSatCtrls.appendChild(groupSatCtrls_Title);

        const saturationControls = document.createElement('div');
        saturationControls.className = 'saturation-controls';
        this.dom.saturationControls = saturationControls;
        groupSatCtrls.appendChild(saturationControls);

        // Palette Swatches
        const paletteSwatches = document.createElement('div');
        paletteSwatches.className = 'palette-swatches';
        this.dom.paletteSwatches = paletteSwatches;

        const paletteHeader = document.createElement('div');
        paletteHeader.className = 'palette-header';
        paletteHeader.style.display = 'flex';
        paletteHeader.style.flexDirection = 'column';
        paletteHeader.style.gap = '10px';
        paletteHeader.appendChild(paletteControls);
        paletteHeader.appendChild(groupSatCtrls);

        paletteColumn.appendChild(paletteHeader);
        paletteColumn.appendChild(paletteSwatches);

        this.containerElement.appendChild(paletteColumn);

        // Event Listeners
        startAngleInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.startAngle = ModelManager.parseInput(startAngleInput.value, 360, 75);
            this.createPalette();
          }
        });

        endAngleInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.endAngle = ModelManager.parseInput(endAngleInput.value, 360, 300);
            this.createPalette();
          }
        });

        angleStepInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.angleStep = ModelManager.parseInput(angleStepInput.value, 90, 45);
            this.createPalette();
          }
        });

        satStartAngleInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.satStartAngle = ModelManager.parseInput(satStartAngleInput.value, 360, 90);
            this.createPalette();
          }
        });

        satEndAngleInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.satEndAngle = ModelManager.parseInput(satEndAngleInput.value, 360, 270);
            this.createPalette();
          }
        });

        satAngleStepInput.addEventListener('input', () => {
          if (this.modelManager) {
            this.modelManager.state.satAngleStep = ModelManager.parseInput(satAngleStepInput.value, 90, 30);
            this.createPalette();
          }
        });

        switchInput.addEventListener('change', () => {
          if (this.modelManager) {
            this.modelManager.state.isVerticalLayout = switchInput.checked;
            this.createPalette();
          }
        });

        visibilityButton.addEventListener('click', () => {
          visibilityDropdown.classList.toggle('active');
        });

        visibilityControls.addEventListener('mouseleave', () => {
          visibilityDropdown.classList.remove('active');
        });
      }

      updateSaturationInputs() {
        if (!this.dom.saturationControls || !this.modelManager) return;
        this.dom.saturationControls.innerHTML = '';

        const groups = [...new Set(relationshipOrder.map(rel => rel.group).filter(g => g !== 'primary'))];
        groups.forEach(group => {
          const groupEl = document.createElement('div');
          groupEl.className = 'saturation-input-group';

          const label = document.createElement('label');
          const groupSymbol = relationshipOrder.find(rel => rel.group === group)?.symbol || '';
          label.textContent = `${groupSymbol}`;
          groupEl.appendChild(label);

          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.max = '100';
          input.value = this.modelManager.state.saturationOverrides[group];
          input.dataset.group = group;
          input.addEventListener('input', () => {
            this.modelManager.state.saturationOverrides[group] = ModelManager.parseInput(input.value, 100, this.modelManager.state.hsl.s);
            relationshipOrder.forEach(rel => {
              if (rel.group === group) {
                delete this.modelManager.state.individualSaturationOverrides[rel.key];
              }
            });
            this.createPalette();
          });

          groupEl.appendChild(input);
          this.dom.saturationControls.appendChild(groupEl);
        });
      }

      updateVisibilityDropdown() {
        if (!this.dom.visibilityDropdown || !this.modelManager) return;
        this.dom.visibilityDropdown.innerHTML = '';

        relationshipOrder.forEach(rel => {
          const option = document.createElement('div');
          option.className = 'visibility-option';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = this.modelManager.state.visibleRelationships[rel.key];
          checkbox.dataset.key = rel.key;
          checkbox.addEventListener('change', () => {
            this.modelManager.state.visibleRelationships[rel.key] = checkbox.checked;
            this.createPalette();
          });

          const label = document.createElement('label');
          label.textContent = `${rel.symbol} ${rel.name}`;

          option.appendChild(label);
          option.appendChild(checkbox);

          this.dom.visibilityDropdown.appendChild(option);
        });
      }

      toggleDropdown(buttonEl) {
        const dropdown = buttonEl.closest('.palette-swatch-group').querySelector('.saturation-dropdown');
        const isActive = dropdown.classList.contains('active');
        // Close all other dropdowns
        document.querySelectorAll('.saturation-dropdown.active').forEach(el => {
          el.classList.remove('active');
        });
        // Toggle the clicked dropdown
        if (!isActive) {
          dropdown.classList.add('active');
        }
      }

      createPalette() {
        if (!this.dom.paletteSwatches || !this.modelManager) return;
        this.dom.paletteSwatches.innerHTML = '';

        const { h, s, l } = this.modelManager.state.hsl;
        const isVertical = this.modelManager.state.isVerticalLayout;
        const startAngle = this.modelManager.state.startAngle || 75;
        const endAngle = this.modelManager.state.endAngle || 300;
        const angleStep = this.modelManager.state.angleStep || 45;
        const satStartAngle = this.modelManager.state.satStartAngle || 90;
        const satEndAngle = this.modelManager.state.satEndAngle || 270;
        const satAngleStep = this.modelManager.state.satAngleStep || 30;
        const range = 2 * Math.PI; // Full circle for lightness and saturation

        const visibleRels = relationshipOrder.filter(rel => this.modelManager.state.visibleRelationships[rel.key]);
        this.dom.paletteSwatches.style.gridTemplateColumns = isVertical ? `repeat(${visibleRels.length}, minmax(150px, 1fr))` : 'auto';

        visibleRels.forEach(rel => {
          const group = document.createElement('div');
          group.className = 'palette-swatch-group';
          group.style.flexDirection = isVertical ? 'column' : 'row';

          const labelContainer = document.createElement('label');
          labelContainer.textContent = `${rel.symbol} ${rel.name}`;
          group.appendChild(labelContainer);

          // Rainbow Button
          const rainbowButton = document.createElement('div');
          rainbowButton.className = 'rainbow-button';
          rainbowButton.textContent = '🌈';
          group.appendChild(rainbowButton);

          const swatchContainer = document.createElement('div');
          swatchContainer.className = isVertical ? 'palette-swatch-column' : 'palette-swatch-line';

          const swatches = [];
          const relHue = (h + rel.offset) % 360;

          // Calculate lightness steps using angular divisions
          const lightnessSteps = [];
          let currentAngle = startAngle;
          const angles = [];

          while (currentAngle <= endAngle) {
            angles.push(currentAngle);
            currentAngle += angleStep;
          }

          // Map angles to lightness values (0-100%)
          angles.forEach(angle => {
            const theta = toRadians(angle);
            const normalizedValue = getValueFromAngle(theta, range);
            const lightness = Math.min(Math.max(normalizedValue * 100, 0), 100);
            lightnessSteps.push(Math.round(lightness));
          });

          // Find the lightness closest to current l and replace it
          if (lightnessSteps.length > 0) {
            const currentL = Math.round(l);
            const closestIndex = lightnessSteps.reduce((closestIdx, stepL, idx) => {
              return Math.abs(stepL - currentL) < Math.abs(lightnessSteps[closestIdx] - currentL) ? idx : closestIdx;
            }, 0);
            lightnessSteps[closestIndex] = currentL;
          }

          // Remove duplicates and sort
          const uniqueLightnessSteps = [...new Set(lightnessSteps)].sort((a, b) => a - b);

          const saturation = this.modelManager.state.individualSaturationOverrides[rel.key] !== undefined ?
            this.modelManager.state.individualSaturationOverrides[rel.key] :
            rel.key === 'primary' ? s : this.modelManager.state.saturationOverrides[rel.group] || s;

          // Main swatches
          uniqueLightnessSteps.forEach(stepL => {
            const rgb = ModelManager.hslToRGB(relHue, saturation, stepL);
            const hex = ModelManager.rgbToHex(rgb.r, rgb.g, rgb.b);
            swatches.push({
              h: relHue,
              s: saturation,
              l: stepL,
              hex,
              isPrimary: rel.key === 'primary' && Math.abs(stepL - l) < 0.01,
              relName: rel.name
            });
          });

          swatches.forEach(swatch => {
            const swatchWrapper = document.createElement('div');
            swatchWrapper.className = 'swatch-wrapper';

            const swatchEl = document.createElement('div');
            swatchEl.className = 'palette-swatch';
            if (swatch.isPrimary) swatchEl.classList.add('primary');
            swatchEl.style.backgroundColor = swatch.hex;

            const hexCode = document.createElement('span');
            hexCode.className = 'hex-code';
            hexCode.textContent = swatch.hex.toUpperCase();
            const swatchLightness = swatch.l;
            const textLightness = swatchLightness > 60 ? 0 : 100;
            const textRGB = ModelManager.hslToRGB(0, 0, textLightness);
            hexCode.style.color = ModelManager.rgbToHex(textRGB.r, textRGB.g, textRGB.b);
            swatchEl.appendChild(hexCode);

            const tooltip = document.createElement('div');
            tooltip.className = 'palette-swatch-tooltip';
            tooltip.textContent = `${swatch.relName}\n${swatch.hex.toUpperCase()}\nhsl(${Math.round(swatch.h)}, ${Math.round(swatch.s)}%, ${Math.round(swatch.l)}%)`;
            swatchEl.appendChild(tooltip);

            const lightness = document.createElement('div');
            lightness.className = 'swatch-lightness';
            lightness.textContent = `${Math.round(swatch.l)}%`;
            swatchWrapper.appendChild(lightness);
            swatchWrapper.appendChild(swatchEl);

            swatchContainer.appendChild(swatchWrapper);
          });

          const infoEl = document.createElement('div');
          infoEl.className = 'swatch-info';
          const hueSpan = document.createElement('span');
          hueSpan.textContent = `H: ${Math.round(relHue)}°`;
          const satInputLabel = document.createElement('label');
          satInputLabel.textContent = `S: `;
          const satInput = document.createElement('input');
          satInput.type = 'number';
          satInput.min = '0';
          satInput.max = '100';
          satInput.value = Math.round(saturation);
          satInput.dataset.key = rel.key;
          satInput.addEventListener('input', () => {
            this.modelManager.state.individualSaturationOverrides[rel.key] = ModelManager.parseInput(satInput.value, 100, this.modelManager.state.saturationOverrides[rel.group] || s);
            this.createPalette();
          });
          satInputLabel.appendChild(satInput);
          infoEl.appendChild(hueSpan);
          infoEl.appendChild(satInputLabel);
          swatchContainer.appendChild(infoEl);

          group.appendChild(swatchContainer);

          // Saturation Dropdown
          const saturationDropdown = document.createElement('div');
          saturationDropdown.className = 'saturation-dropdown';

          // Calculate saturation levels using angular divisions
          const saturationLevels = [];
          let currentSatAngle = satStartAngle;
          const satAngles = [];

          while (currentSatAngle <= satEndAngle) {
            satAngles.push(currentSatAngle);
            currentSatAngle += satAngleStep;
          }

          // Map angles to saturation values (0-100%)
          satAngles.forEach(angle => {
            const theta = toRadians(angle);
            const normalizedValue = getValueFromAngle(theta, range);
            const saturation = Math.min(Math.max(normalizedValue * 100, 0), 100);
            saturationLevels.push(Math.round(saturation));
          });

          // Remove duplicates
          const uniqueSaturationLevels = [...new Set(saturationLevels)];

          uniqueSaturationLevels.forEach(satLevel => {
            const satRow = document.createElement('div');
            satRow.className = 'saturation-row';
            satRow.dataset.saturation = satLevel;
            satRow.dataset.key = rel.key;

            const satLabel = document.createElement('label');
            satLabel.textContent = `${satLevel}%`;
            satRow.appendChild(satLabel);

            const satSwatchContainer = document.createElement('div');
            satSwatchContainer.className = isVertical ? 'palette-swatch-column' : 'palette-swatch-line';

            uniqueLightnessSteps.forEach(stepL => {
              const rgb = ModelManager.hslToRGB(relHue, satLevel, stepL);
              const hex = ModelManager.rgbToHex(rgb.r, rgb.g, rgb.b);
              const swatchWrapper = document.createElement('div');
              swatchWrapper.className = 'swatch-wrapper';

              const swatchEl = document.createElement('div');
              swatchEl.className = 'palette-swatch';
              swatchEl.style.backgroundColor = hex;

              const hexCode = document.createElement('span');
              hexCode.className = 'hex-code';
              hexCode.textContent = hex.toUpperCase();
              const textLightness = stepL > 60 ? 0 : 100;
              const textRGB = ModelManager.hslToRGB(0, 0, textLightness);
              hexCode.style.color = ModelManager.rgbToHex(textRGB.r, textRGB.g, textRGB.b);
              swatchEl.appendChild(hexCode);

              const tooltip = document.createElement('div');
              tooltip.className = 'palette-swatch-tooltip';
              tooltip.textContent = `${rel.name}\n${hex.toUpperCase()}\nhsl(${Math.round(relHue)}, ${satLevel}%, ${Math.round(stepL)}%)`;
              swatchEl.appendChild(tooltip);

              //const lightness = document.createElement('div');
              //lightness.className = 'swatch-lightness';
              //lightness.textContent = `${Math.round(stepL)}%`;
              //swatchWrapper.appendChild(lightness);
              swatchWrapper.appendChild(swatchEl);

              satSwatchContainer.appendChild(swatchWrapper);
            });

            satRow.appendChild(satSwatchContainer);
            saturationDropdown.appendChild(satRow);

            satRow.addEventListener('click', () => {
              this.modelManager.state.individualSaturationOverrides[rel.key] = satLevel;
              this.createPalette();
            });
          });

          group.appendChild(saturationDropdown);

          // Rainbow button event
          rainbowButton.addEventListener('click', () => this.toggleDropdown(rainbowButton));

          if (rel.key === 'primary') {
            const groupWrapper = document.createElement('div');
            groupWrapper.className = 'primary-container';
            groupWrapper.appendChild(group);
            this.dom.paletteSwatches.appendChild(groupWrapper);
          } else {
            this.dom.paletteSwatches.appendChild(group);
          }
        });
      }

      update() {
        this.updateSaturationInputs();
        this.updateVisibilityDropdown();
        this.createPalette();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const dom = {
        paletteContainer: document.getElementById('palette-container'),
        rgbInputs: document.getElementById('rgb-inputs'),
        hslInputs: document.getElementById('hsl-inputs'),
        rgbSwatches: document.getElementById('rgb-swatches'),
        hslSwatches: document.getElementById('hsl-swatches'),
        colorSwatch: document.getElementById('colorSwatch'),
        paletteControlsContainer: document.getElementById('palette-controls-container')
      };

      const paletteManager = new PaletteManager(dom.paletteControlsContainer);
      const modelManager = new ModelManager(paletteManager);

      // Extend state with angular controls
      modelManager.state.startAngle = 75;
      modelManager.state.endAngle = 300;
      modelManager.state.angleStep = 45;
      modelManager.state.satStartAngle = 90;
      modelManager.state.satEndAngle = 270;
      modelManager.state.satAngleStep = 30;

      modelManager.inputControls('rgb', dom.rgbInputs);
      modelManager.inputControls('hsl', dom.hslInputs);
      modelManager.swatchControls('rgb', dom.rgbSwatches);
      modelManager.swatchControls('hsl', dom.hslSwatches);
      modelManager.currentSwatch(dom.colorSwatch);
    });
  </script>
</body>
</html>